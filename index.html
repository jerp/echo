<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Echo</title>
</head>
<body>
  <pre style="color: lightgrey;">-</pre>
  <script>
    var startedAt = new Date()
    function at() {
      return '@' + Math.floor((new Date() - startedAt) / 1000) + 's'
    }
    function timeStamp() {
      return (new Date()).toLocaleTimeString('fr-FR')
    }
    function addToDom(req) {
      var el = document.createElement('div')
      el.innerHTML = '<pre style="color: lightgrey;">' + timeStamp() + ' - ' + at()  + '</pre>' +
        '<pre>' +
          req.method + ' ' + req.url +
        '</pre><pre>' +
          Object.keys(req.headers).map(n => n+':'+req.headers[n]).join('\n') +
        (req.body ? '</pre><pre>' +
          req.safeBody : '') +
        '</pre>'
      document.body.insertBefore(el, document.body.firstElementChild)
    }
    document.body.firstElementChild.innerText = timeStamp() + ' - start'
    var socket = new WebSocket(location.protocol.replace('http', 'ws')+ '//' + location.host + '/ws')
    window.echos = []
    socket.onmessage = function(m) {
      if (m.data) {
        try {
          var resp = JSON.parse(m.data)
          window.echos.last = Object.create(null, Object.assign(Object.getOwnPropertyDescriptors(resp), {
            safeBody: {
              get() {
                var maxLength = 1024 * 10
                if (resp.body && resp.body.length > maxLength) {
                  return resp.body.slice(0, maxLength) + '...'
                } else {
                  return resp.body
                }
              }
            },
            data: {
              get() {
                var contentType = resp.headers['Content-Type'] || resp.headers['content-type']
                if (/json/.test(contentType)) {
                  try {
                    return JSON.parse(resp.body)
                  } catch(e) {
                    return this.safeBody()
                  }
                } else if (/xml/.test(contentType)) {
                  try {
                    var parser = new DOMParser();
                    return parser.parseFromString(resp.body, contentType.replace(/;.*/, ''))
                  } catch(e) {
                    return this.safeBody
                  }
                } else {
                  return this.safeBody
                }
              }
            }
          }))
          window.echos.last = window.echos.last
          window.echos.push(window.echos.last)
          addToDom(window.echos.last)
        } catch (e) {
          console.log(m.data.slice(0, 1024 * 100))
        }
      }
    }
  </script>
</body>
</html>